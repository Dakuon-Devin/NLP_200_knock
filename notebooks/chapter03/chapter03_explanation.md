# 第3章: 正規表現 - 解説

## 問題20: JSONデータの読み込み
### 問題の概要
この問題では、Wikipedia記事のJSONファイルを読み込み、「イギリス」に関する記事本文を表示するプログラムを実装します。

### 解法のポイント
1. **JSONファイルの読み込み**：
   Pythonの`json`モジュールを使用して、JSONファイルを読み込みます。
   ```python
   import json
   
   # JSONファイルを読み込む
   with open('jawiki-country.json', 'r', encoding='utf-8') as f:
       for line in f:
           data = json.loads(line)
           if data['title'] == 'イギリス':
               print(data['text'])
               break
   ```

2. **エンコーディングの指定**：
   日本語を含むファイルを読み込む際は、適切なエンコーディング（通常は'utf-8'）を指定することが重要です。

### 実装上の注意点
- JSONファイルの各行が1つのJSON形式のデータになっている場合は、1行ずつ読み込んで処理する必要があります。
- 大きなJSONファイルの場合、メモリ効率を考慮して、1行ずつ読み込んで処理する方法が適しています。

## 問題21: カテゴリ名を含む行を抽出
### 問題の概要
この問題では、Wikipediaの記事中でカテゴリ名を表す行を抽出するプログラムを実装します。

### 解法のポイント
1. **正規表現を使用したカテゴリ行の抽出**：
   Wikipediaのカテゴリは、`[[Category:カテゴリ名]]`の形式で記述されています。これを正規表現で抽出します。
   ```python
   import re
   
   # イギリスの記事本文
   uk_text = get_uk_text()  # 問題20で実装した関数を使用
   
   # カテゴリ行を抽出
   category_pattern = r'\[\[Category:(.+?)(?:\|.*)?\]\]'
   for line in uk_text.split('\n'):
       if re.search(category_pattern, line):
           print(line)
   ```

2. **正規表現パターンの解説**：
   - `\[\[Category:(.+?)(?:\|.*)?\]\]`
     - `\[\[` と `\]\]` は、`[[` と `]]` をエスケープして表現
     - `Category:` は、カテゴリを示す文字列
     - `(.+?)` は、任意の1文字以上の文字列を非貪欲（non-greedy）にマッチさせ、キャプチャグループとして取得
     - `(?:\|.*)?` は、`|` とそれに続く任意の文字列が0回または1回出現することを表す（非キャプチャグループ）

### 実装上の注意点
- 正規表現の非貪欲マッチング（`?`を使用）は、最短一致を行うため、複数のカテゴリが1行に含まれる場合でも適切に抽出できます。
- カテゴリ名にはパイプ記号（`|`）が含まれることがあり、これはカテゴリのソート用キーを指定するために使用されます。この部分は除外する必要があります。
## 問題22: カテゴリ名の抽出
### 問題の概要
この問題では、Wikipediaの記事中のカテゴリ名を抽出するプログラムを実装します。

### 解法のポイント
1. **正規表現を使用したカテゴリ名の抽出**：
   問題21と同様に正規表現を使用しますが、今回はカテゴリ名部分のみを抽出します。
   ```python
   import re
   
   # イギリスの記事本文
   uk_text = get_uk_text()  # 問題20で実装した関数を使用
   
   # カテゴリ名を抽出
   category_pattern = r'\[\[Category:(.+?)(?:\|.*)?\]\]'
   for line in uk_text.split('\n'):
       match = re.search(category_pattern, line)
       if match:
           print(match.group(1))  # キャプチャグループの内容を表示
   ```

2. **キャプチャグループの使用**：
   正規表現の括弧`()`で囲まれた部分はキャプチャグループとなり、`match.group(1)`で取得できます。

### 実装上の注意点
- カテゴリ名にパイプ記号（`|`）が含まれる場合、その前の部分のみがカテゴリ名となります。正規表現パターンでは、この部分を考慮しています。
- 複数のカテゴリが1行に含まれる場合、`re.findall()`を使用することで、すべてのカテゴリ名を抽出できます。

## 問題23: セクション構造
### 問題の概要
この問題では、Wikipediaの記事中のセクション名とそのレベル（見出しレベル）を抽出するプログラムを実装します。

### 解法のポイント
1. **正規表現を使用したセクション構造の抽出**：
   Wikipediaのセクション（見出し）は、`==セクション名==`の形式で記述されています。`=`の数がレベルを表します。
   ```python
   import re
   
   # イギリスの記事本文
   uk_text = get_uk_text()  # 問題20で実装した関数を使用
   
   # セクション構造を抽出
   section_pattern = r'^(={2,})\s*(.+?)\s*\1$'
   for line in uk_text.split('\n'):
       match = re.match(section_pattern, line)
       if match:
           level = len(match.group(1)) - 1  # レベルは'='の数から1を引いた値
           name = match.group(2)
           print(f"{level} {name}")
   ```

2. **正規表現パターンの解説**：
   - `^(={2,})\s*(.+?)\s*\1$`
     - `^` と `$` は、行の先頭と末尾を表す
     - `(={2,})` は、2つ以上の連続する`=`をキャプチャグループとして取得
     - `\s*` は、0個以上の空白文字
     - `(.+?)` は、任意の1文字以上の文字列を非貪欲にマッチさせ、キャプチャグループとして取得
     - `\1` は、1番目のキャプチャグループ（`={2,}`）と同じ内容を表す後方参照

### 実装上の注意点
- セクションレベルは、`=`の数から1を引いた値として計算します（例：`==` はレベル1、`===` はレベル2）。
- 正規表現の後方参照（`\1`）を使用することで、開始と終了の`=`の数が同じであることを確認できます。
## 問題24: ファイル参照の抽出
### 問題の概要
この問題では、Wikipediaの記事中のファイル参照（画像など）を抽出するプログラムを実装します。

### 解法のポイント
1. **正規表現を使用したファイル参照の抽出**：
   Wikipediaのファイル参照は、`[[ファイル:ファイル名|オプション]]`または`[[File:ファイル名|オプション]]`の形式で記述されています。
   ```python
   import re
   
   # イギリスの記事本文
   uk_text = get_uk_text()  # 問題20で実装した関数を使用
   
   # ファイル参照を抽出
   file_pattern = r'\[\[(ファイル|File):(.+?)\|.+?\]\]'
   for line in uk_text.split('\n'):
       for match in re.finditer(file_pattern, line):
           print(match.group(2))  # ファイル名を表示
   ```

2. **正規表現パターンの解説**：
   - `\[\[(ファイル|File):(.+?)\|.+?\]\]`
     - `\[\[` と `\]\]` は、`[[` と `]]` をエスケープして表現
     - `(ファイル|File)` は、「ファイル」または「File」のいずれかにマッチ
     - `:` は、コロン
     - `(.+?)` は、任意の1文字以上の文字列を非貪欲にマッチさせ、キャプチャグループとして取得（ファイル名）
     - `\|` は、パイプ記号をエスケープして表現
     - `.+?` は、任意の1文字以上の文字列を非貪欲にマッチ（オプション部分）

### 実装上の注意点
- ファイル参照には、サイズやキャプションなどのオプションが含まれることがあります。これらはパイプ記号（`|`）で区切られています。
- 複数のファイル参照が1行に含まれる場合、`re.finditer()`を使用することで、すべてのファイル参照を抽出できます。
## 問題25: テンプレートの抽出
### 問題の概要
この問題では、Wikipediaの記事中の「基礎情報」テンプレートを抽出し、テンプレート内のフィールド名と値を辞書オブジェクトとして取得するプログラムを実装します。

### 解法のポイント
1. **正規表現を使用したテンプレートの抽出**：
   基礎情報テンプレートは、`{{基礎情報 国\n|フィールド名1 = 値1\n|フィールド名2 = 値2\n...}}`の形式で記述されています。
   ```python
   import re
   
   # イギリスの記事本文
   uk_text = get_uk_text()  # 問題20で実装した関数を使用
   
   # 基礎情報テンプレートを抽出
   template_pattern = r'{{基礎情報 国\n(.*?)\n}}'
   template_match = re.search(template_pattern, uk_text, re.DOTALL)
   
   if template_match:
       template_text = template_match.group(1)
       
       # フィールド名と値を抽出
       field_pattern = r'\|(.+?)\s*=\s*(.+?)(?=\n\||\n$)'
       fields = re.findall(field_pattern, template_text, re.DOTALL)
       
       # 辞書オブジェクトを作成
       basic_info = {}
       for name, value in fields:
           basic_info[name] = value.strip()
       
       # 結果を表示
       for name, value in basic_info.items():
           print(f"{name}: {value}")
   ```

2. **正規表現パターンの解説**：
   - テンプレート抽出パターン: `{{基礎情報 国\n(.*?)\n}}`
     - `{{` と `}}` は、テンプレートの開始と終了を表す
     - `基礎情報 国` は、テンプレート名
     - `\n` は、改行
     - `(.*?)` は、任意の0文字以上の文字列を非貪欲にマッチさせ、キャプチャグループとして取得
   
   - フィールド抽出パターン: `\|(.+?)\s*=\s*(.+?)(?=\n\||\n$)`
     - `\|` は、パイプ記号をエスケープして表現
     - `(.+?)` は、任意の1文字以上の文字列を非貪欲にマッチさせ、キャプチャグループとして取得（フィールド名）
     - `\s*=\s*` は、等号の前後に0個以上の空白文字
     - `(.+?)` は、任意の1文字以上の文字列を非貪欲にマッチさせ、キャプチャグループとして取得（値）
     - `(?=\n\||\n$)` は、先読み（lookahead）で、次のフィールドの開始（`\n|`）または文字列の終わり（`\n$`）を表す

### 実装上の注意点
- テンプレートの抽出には、複数行にまたがるパターンにマッチさせるために、`re.DOTALL`フラグを使用します。
- フィールドの値が複数行にわたる場合、正規表現の工夫が必要です。先読み（lookahead）を使用することで、次のフィールドの開始または文字列の終わりまでを値として取得できます。
- 実際のWikipediaのテンプレートはより複雑な構造を持つことがあり、入れ子になったテンプレートや特殊な構文が含まれる場合があります。
## 問題26: 強調マークアップの除去
### 問題の概要
この問題では、Wikipediaの記事から抽出した基礎情報テンプレートの値から、MediaWikiの強調マークアップを除去する処理を実装します。

### MediaWikiの強調マークアップの種類
MediaWikiでは、以下の3種類の強調マークアップが使用されています：

1. **弱い強調**：`''テキスト''`（2つのアポストロフィで囲む）
   - HTMLでは `<i>テキスト</i>` に変換され、通常は斜体で表示されます。

2. **強い強調**：`'''テキスト'''`（3つのアポストロフィで囲む）
   - HTMLでは `<b>テキスト</b>` に変換され、通常は太字で表示されます。

3. **強い強調かつ斜体**：`'''''テキスト'''''`（5つのアポストロフィで囲む）
   - HTMLでは `<b><i>テキスト</i></b>` に変換され、通常は太字かつ斜体で表示されます。

### 解法のポイント
1. **正規表現を使用した強調マークアップの除去**：
   強調マークアップを除去するには、正規表現の置換機能を使用します。重要なのは、処理の順序です。最も長いパターン（5つのアポストロフィ）から順に処理することで、短いパターンが長いパターンの一部として誤って処理されることを防ぎます。

   ```python
   import re
   
   def remove_emphasis_markup(text):
       # 強い強調かつ斜体（5つのアポストロフィ）
       text = re.sub(r"'''''(.+?)'''''", r"\1", text)
       # 強い強調（3つのアポストロフィ）
       text = re.sub(r"'''(.+?)'''", r"\1", text)
       # 弱い強調（2つのアポストロフィ）
       text = re.sub(r"''(.+?)''", r"\1", text)
       return text
   ```

2. **非貪欲マッチングの使用**：
   正規表現の `(.+?)` は非貪欲（non-greedy）マッチングを行います。これにより、最初のマッチングで終了し、複数の強調マークアップが連続している場合でも適切に処理できます。

### 実装上の注意点
1. **入れ子になった強調マークアップ**：
   強調マークアップが入れ子になっている場合（例：`'''''テキスト'''''` の中に `''テキスト''` がある場合）、複数回の置換が必要になることがあります。

2. **複雑な組み合わせ**：
   実際のWikipediaの記事では、強調マークアップが複雑に組み合わされている場合があります。

3. **他のマークアップとの相互作用**：
   強調マークアップは他のマークアップ（リンクなど）と組み合わせて使用されることがあります。これらの相互作用を考慮する必要があります。
## 問題27: 内部リンクの除去
### 問題の概要
この問題では、Wikipediaの記事から抽出した基礎情報テンプレートの値から、MediaWikiの内部リンクマークアップを除去する処理を実装します。

### MediaWikiの内部リンクマークアップ
MediaWikiの内部リンクは、以下の形式で記述されます：

1. **基本形式**：`[[ページ名]]`
   - 表示テキストはページ名と同じになります。

2. **表示テキスト指定形式**：`[[ページ名|表示テキスト]]`
   - パイプ記号（`|`）の後に指定したテキストが表示されます。

3. **セクション指定形式**：`[[ページ名#セクション名]]`
   - ページ内の特定のセクションにリンクします。

4. **言語間リンク**：`[[言語コード:ページ名]]`
   - 他の言語版のWikipediaの記事にリンクします。

### 解法のポイント
1. **正規表現を使用した内部リンクの除去**：
   内部リンクを除去するには、正規表現の置換機能を使用します。表示テキストが指定されている場合は表示テキストを、指定されていない場合はページ名を残します。

   ```python
   import re
   
   def remove_internal_links(text):
       # パターン1: [[ページ名|表示テキスト]] → 表示テキスト
       text = re.sub(r"\[\[(?:[^|]*?\|)?([^|]*?)\]\]", r"\1", text)
       return text
   ```

2. **正規表現パターンの解説**：
   - `\[\[(?:[^|]*?\|)?([^|]*?)\]\]`
     - `\[\[` と `\]\]` は、`[[` と `]]` をエスケープして表現
     - `(?:[^|]*?\|)?` は、パイプ記号までの任意の文字列（ページ名）が0回または1回出現することを表す（非キャプチャグループ）
     - `([^|]*?)` は、パイプ記号を含まない任意の文字列（表示テキストまたはページ名）をキャプチャグループとして取得

### 実装上の注意点
1. **複雑なリンク構造**：
   実際のWikipediaの記事では、より複雑なリンク構造が使用されることがあります。例えば、リンク内にテンプレートや他のマークアップが含まれる場合があります。

2. **言語間リンクの処理**：
   言語間リンク（例：`[[en:England]]`）は、通常は記事の本文には表示されないため、特別な処理が必要な場合があります。

3. **ファイルリンクの処理**：
   ファイルリンク（例：`[[ファイル:Flag of the United Kingdom.svg|thumb|イギリスの国旗]]`）は、特別な処理が必要な場合があります。
## 問題28: MediaWikiマークアップの除去
### 問題の概要
この問題では、問題26と問題27で実装した強調マークアップと内部リンクマークアップの除去に加えて、その他のMediaWikiマークアップも可能な限り除去し、国の基本情報を整形する処理を実装します。

### MediaWikiのマークアップの種類
MediaWikiには、以下のようなさまざまなマークアップが存在します：

1. **強調マークアップ**（問題26で対応）
   - 弱い強調（`''テキスト''`）
   - 強い強調（`'''テキスト'''`）
   - 強い強調かつ斜体（`'''''テキスト'''''`）

2. **内部リンクマークアップ**（問題27で対応）
   - 基本形式（`[[リンク先]]`）
   - 表示テキスト指定形式（`[[リンク先|表示テキスト]]`）

3. **外部リンクマークアップ**
   - 基本形式（`[URL]`）
   - 表示テキスト指定形式（`[URL 表示テキスト]`）

4. **HTMLタグ**
   - 開始タグと終了タグのペア（`<タグ>内容</タグ>`）
   - 単独のタグ（`<タグ />`）

5. **参照タグ**
   - 基本形式（`<ref>内容</ref>`）
   - 名前付き参照（`<ref name="名前">内容</ref>`）
   - 参照の再利用（`<ref name="名前" />`）

6. **テンプレート呼び出し**
   - 基本形式（`{{テンプレート名}}`）
   - パラメータ付き（`{{テンプレート名|パラメータ}}`）

7. **言語間リンク**
   - 基本形式（`[[言語コード:ページ名]]`）

8. **コメント**
   - HTMLコメント形式（`<!-- コメント -->`）

9. **マジックワード**
   - 基本形式（`__マジックワード__`）

### 解法のポイント
1. **マークアップ除去関数の実装**：
   各種マークアップを除去するために、それぞれに対応する関数を実装します：

   ```python
   # 外部リンクマークアップを除去する関数
   def remove_external_links(text):
       # パターン1: [URL 表示テキスト] → 表示テキスト
       text = re.sub(r"\[(?:https?|ftp)://[^\s\]]+\s+([^\]]+)\]", r"\1", text)
       # パターン2: [URL] → URL
       text = re.sub(r"\[((?:https?|ftp)://[^\s\]]+)\]", r"\1", text)
       return text
   
   # HTMLタグを除去する関数
   def remove_html_tags(text):
       # HTMLタグ: <タグ>内容</タグ> → 内容
       text = re.sub(r"<[^>]+>([^<]*)</[^>]+>", r"\1", text)
       # 単独のHTMLタグ: <タグ /> → 空文字列
       text = re.sub(r"<[^>]+/>", "", text)
       # その他のHTMLタグ: <タグ> → 空文字列
       text = re.sub(r"<[^>]+>", "", text)
       return text
   
   # 参照タグを除去する関数
   def remove_ref_tags(text):
       # パターン1: <ref>内容</ref> → 空文字列
       text = re.sub(r"<ref[^>]*>.*?</ref>", "", text)
       # パターン2: <ref name="名前" /> → 空文字列
       text = re.sub(r"<ref[^/>]*/>", "", text)
       return text
   ```

2. **すべてのマークアップを除去する関数の実装**：
   各種マークアップ除去関数を組み合わせて、すべてのマークアップを除去する関数を実装します：

   ```python
   def remove_all_markup(text):
       # コメントを除去
       text = remove_comments(text)
       # 参照タグを除去
       text = remove_ref_tags(text)
       # HTMLタグを除去
       text = remove_html_tags(text)
       # 言語間リンクを除去
       text = remove_language_links(text)
       # 外部リンクマークアップを除去
       text = remove_external_links(text)
       # 内部リンクマークアップを除去
       text = remove_internal_links(text)
       # 強調マークアップを除去
       text = remove_emphasis_markup(text)
       # マジックワードを除去
       text = remove_magic_words(text)
       # テンプレート呼び出しを除去
       text = remove_template_calls(text)
       # 連続する空白を1つの空白に置換
       text = re.sub(r"\s+", " ", text)
       # 前後の空白を削除
       text = text.strip()
       return text
   ```

3. **処理の順序**：
   マークアップの除去順序は重要です。例えば、コメントや参照タグは他のマークアップを含んでいる可能性があるため、先に除去する必要があります。また、テンプレート呼び出しは入れ子になっている可能性があり、正規表現だけでは完全に処理できないことがあります。

### 実装上の注意点
1. **入れ子になったマークアップ**：
   マークアップが入れ子になっている場合、単純な正規表現だけでは完全に処理できないことがあります。特にテンプレート呼び出しは複雑な構造を持つことがあります。

2. **複雑なマークアップ**：
   実際のWikipediaの記事では、より複雑なマークアップが使用されることがあります。この実装では、一般的なマークアップのみを対象としています。

3. **テキストの整形**：
   マークアップを除去した後、連続する空白を1つの空白に置換し、前後の空白を削除することで、より読みやすいテキストにしています。
## 問題29: 国旗画像のURLを取得する
### 問題の概要
この問題では、基礎情報テンプレートから国旗画像のファイル名を抽出し、MediaWiki APIを使用してその画像のURLを取得する方法を実装します。

### MediaWiki APIとは
MediaWiki APIは、WikipediaなどのMediaWikiベースのウェブサイトのコンテンツにプログラムからアクセスするためのインターフェースです。このAPIを使用することで、記事の内容、画像情報、編集履歴など、さまざまな情報を取得できます。

### 解法のポイント
1. **国旗画像のファイル名の抽出**：
   基礎情報テンプレートには、「国旗画像」または「旗画像」というフィールドに国旗の画像ファイル名が記載されています。問題25で実装した基礎情報テンプレートの抽出関数を使用して、これらのフィールドから国旗画像のファイル名を抽出します。

   ```python
   def extract_flag_filename(basic_info):
       """基礎情報テンプレートから国旗画像のファイル名を抽出する関数"""
       # 国旗画像のフィールド名（「国旗画像」または「旗画像」）
       flag_field_names = ["国旗画像", "旗画像"]
       
       # 国旗画像のフィールドを探す
       flag_filename = None
       for field_name in flag_field_names:
           if field_name in basic_info:
               flag_filename = basic_info[field_name]
               break
       
       return flag_filename
   ```

2. **MediaWiki APIを使用した画像URLの取得**：
   MediaWiki APIを使用して、抽出した国旗画像のファイル名からURLを取得します。APIリクエストには以下のパラメータを指定します：

   - `action=query`: クエリアクションを指定
   - `prop=imageinfo`: 画像情報を取得するプロパティを指定
   - `titles=ファイル名`: 情報を取得するファイルのタイトルを指定
   - `iiprop=url`: 画像のURLを取得するプロパティを指定

   ```python
   def get_image_url(filename):
       """MediaWiki APIを使用して画像のURLを取得する関数"""
       # ファイル名の先頭に「ファイル:」または「File:」がない場合は追加
       if not filename.startswith(("ファイル:", "File:")):
           filename = "File:" + filename
       
       # MediaWiki APIのエンドポイント
       api_url = "https://ja.wikipedia.org/w/api.php"
       
       # APIリクエストのパラメータ
       params = {
           "action": "query",
           "format": "json",
           "prop": "imageinfo",
           "titles": filename,
           "iiprop": "url"
       }
       
       # APIリクエストを送信し、レスポンスから画像のURLを抽出
       response = requests.get(api_url, params=params)
       data = response.json()
       
       pages = data["query"]["pages"]
       for page_id in pages:
           if "imageinfo" in pages[page_id]:
               return pages[page_id]["imageinfo"][0]["url"]
       
       return None
   ```

### 実装上の注意点
1. **ファイル名の形式**：
   Wikipediaのファイル名は「ファイル:」または「File:」で始まる必要があります。抽出したファイル名にこのプレフィックスがない場合は追加する必要があります。

2. **APIの利用制限**：
   MediaWiki APIには利用制限があるため、大量のリクエストを短時間に送信すると制限される可能性があります。実際のアプリケーションでは、キャッシュやレート制限の対策を実装することが重要です。

3. **エラー処理**：
   APIリクエストが失敗した場合や、画像情報が取得できなかった場合のエラー処理を実装することが重要です。例外処理を使用して、エラーメッセージを表示するなどの対応が必要です。

4. **画像の著作権**：
   Wikipediaの画像には著作権があるため、利用する際は適切なライセンス表示が必要です。画像のライセンス情報も同様にAPIから取得できます（`iiprop=url|extmetadata`を指定）。
